name: Release

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Release Note
        id: release_note
        run: |
          echo "date=$(date +'%Y.%m.%d')" >> "$GITHUB_OUTPUT"
          echo "short_sha=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          
          # Get the last tag, if it exists
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            # If no tags, get all messages
            MESSAGES=$(git log --pretty=format:"- %s")
          else
            # Get messages between last tag and current HEAD
            MESSAGES=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s")
          fi
          
          # Handle multiline output safely in GitHub Actions
          {
            echo "changelog<<EOF"
            echo "$MESSAGES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Tag
        run: |
          TAG="v${{ steps.release_note.outputs.date }}-${{ steps.release_note.outputs.short_sha }}"
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag -a "$TAG" -m "Release $TAG" -m "${{ steps.release_note.outputs.changelog }}"
          git push origin "$TAG"
